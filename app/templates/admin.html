<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel Admin - Questionário</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='puzzle.ico') }}" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <div class="container py-5">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary">Painel Administrativo</h2>
        <div>
          <a href="{{ url_for('main.index') }}" class="btn btn-outline-primary me-2"
            >Ver Questionário</a
          >
          <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-danger">Sair</a>
        </div>
      </div>

      {% with messages = get_flashed_messages() %} {% if messages %} {% for message in messages %}
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
      {% endfor %} {% endif %} {% endwith %}

      <!-- Seção de Resultados -->
      <div class="card mb-4">
        <div class="card-header">
          <h4 class="mb-0">Resultados dos Questionários</h4>
        </div>
        <div class="card-body">
          {% if resultados %}
          <div class="d-flex justify-content-between mb-3">
            <button id="export-csv-btn" class="btn btn-outline-success">
              Exportar Resultados (CSV)
            </button>
            <button type="button" class="btn btn-outline-danger" onclick="clearAllResults()">
              Apagar Todos os Resultados
            </button>
          </div>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Data/Hora</th>
                  <th>Pontuação</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody>
                {% for resultado in resultados %}
                <tr>
                  <td>{{ resultado.nome }}</td>
                  <td>{{ resultado.data.strftime('%d/%m/%Y %H:%M') }}</td>
                  <td>
                    <span class="badge bg-primary"
                      >{{ "%.2f"|format(resultado.pontuacao_total) }}</span
                    >
                  </td>
                  <td>
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-info"
                      data-bs-toggle="modal"
                      data-bs-target="#modal{{ resultado.id }}"
                    >
                      Ver Respostas
                    </button>
                  </td>
                </tr>

                <!-- Modal de respostas -->
                <div class="modal fade" id="modal{{ resultado.id }}" tabindex="-1">
                  <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">Respostas de {{ resultado.nome }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        {% set respostas_dict = resultado.get_respostas_dict() %} {% for resp_id,
                        resp_data in respostas_dict.items() %}
                        <div class="mb-3">
                          <strong>{{ resp_data.pergunta }}</strong><br />
                          <span class="text-muted">Resposta:</span> {{ resp_data.resposta }}<br />
                          <span class="text-muted">Peso:</span>
                          <span class="badge bg-secondary">{{ resp_data.peso }}</span>
                        </div>
                        {% endfor %}
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                          Fechar
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <p class="text-muted">Nenhum questionário respondido ainda.</p>
          {% endif %}
        </div>
      </div>

      <!-- Seção de Perguntas -->
      <div class="card mb-4">
        <div class="card-header">
          <h4 class="mb-0">Gerenciar Perguntas</h4>
        </div>
        <div class="card-body">
          <!-- Importar Perguntas -->
          <div class="mb-4">
            <h5>Importar Perguntas em Lote</h5>
            <form
              id="import-questions-form"
              action="{{ url_for('main.import_questions') }}"
              method="POST"
            >
              <div class="mb-3">
                <label class="form-label">
                  Formato: uma pergunta por linha, seguida das opções<br />
                  <small class="text-muted">
                    Exemplo:<br />
                    pergunta: "Você gosta de maçã?"<br />
                    opcoes e peso: "sim:1","nao:0","talvez:0.5"
                  </small>
                </label>
                <textarea
                  class="form-control"
                  name="questions_data"
                  rows="4"
                  placeholder="Cole aqui os dados das perguntas..."
                ></textarea>
              </div>
              <button type="submit" class="btn btn-info">Importar Perguntas</button>
            </form>
          </div>

          <hr />

          <!-- Adicionar Nova Pergunta -->
          <div class="mb-4">
            <h5>Adicionar Nova Pergunta</h5>
            <form id="add-question-form" action="{{ url_for('main.add_question') }}" method="POST">
              <div class="mb-3">
                <label class="form-label">Texto da Pergunta</label>
                <textarea name="question_text" class="form-control" rows="2" required></textarea>
              </div>

              <div class="mb-3">
                <label class="form-label">Opções de Resposta</label>
                <div id="options-container">
                  <div class="row mb-2 option-row">
                    <div class="col-7">
                      <input
                        type="text"
                        class="form-control"
                        name="option_text"
                        placeholder="Texto da opção"
                        required
                      />
                    </div>
                    <div class="col-3">
                      <input
                        type="text"
                        class="form-control weight-input"
                        name="option_weight"
                        placeholder="Peso"
                        step="0.1"
                        inputmode="decimal"
                        required
                      />
                    </div>
                    <div class="col-2">
                      <button
                        type="button"
                        class="btn btn-danger btn-sm w-100"
                        onclick="removeOption(this)"
                      >
                        ×
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <button type="button" class="btn btn-outline-secondary mb-3" onclick="addOption()">
                + Adicionar Opção
              </button>
              <br />
              <button type="submit" class="btn btn-primary">Adicionar Pergunta</button>
            </form>
          </div>

          <hr />

          <!-- Lista de perguntas existentes -->
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>Perguntas Cadastradas</h5>
            {% if questions %}
            <button type="button" class="btn btn-outline-danger" onclick="deleteAllQuestions()">
              Apagar Todas as Perguntas
            </button>
            {% endif %}
          </div>

          <div id="questions-list">
            {% if questions %} {% for question in questions %}
            <div class="card mb-3">
              <div class="card-body">
                <form
                  class="edit-question-form"
                  data-question-id="{{ question.id }}"
                  action="{{ url_for('main.edit_question', question_id=question.id) }}"
                  method="POST"
                >
                  <div class="mb-3">
                    <label class="form-label">Pergunta {{ loop.index }}:</label>
                    <textarea name="question_text" class="form-control" rows="2">
{{ question.text }}</textarea
                    >
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Opções:</label>
                    <div class="options-container">
                      {% for option in question.options %}
                      <div class="row mb-2 option-row" id="option-row-{{ option.id }}">
                        <div class="col-7">
                          <input
                            type="text"
                            class="form-control"
                            name="option_text_{{ option.id }}"
                            value="{{ option.text }}"
                          />
                        </div>
                        <div class="col-3">
                          <input
                            type="text"
                            class="form-control weight-input"
                            name="option_weight_{{ option.id }}"
                            value="{% if option.weight == option.weight|int %}{{ option.weight|int }}{% else %}{{ option.weight|replace('.', ',') }}{% endif %}"
                            step="0.1"
                            inputmode="decimal"
                          />
                        </div>
                        <div class="col-2">
                          <button
                            type="button"
                            class="btn btn-danger btn-sm w-100 delete-option-btn"
                            data-option-id="{{ option.id }}"
                            data-question-id="{{ question.id }}"
                            onclick="checkAndDeleteOption(this)"
                          >
                            ×
                          </button>
                        </div>
                      </div>
                      {% endfor %}
                    </div>

                    <button
                      type="button"
                      class="btn btn-outline-secondary btn-sm mt-2"
                      onclick="addOptionToQuestion('{{ question.id }}')"
                    >
                      + Adicionar Opção
                    </button>
                  </div>

                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success btn-sm">Salvar Alterações</button>
                    <button
                      type="button"
                      class="btn btn-danger btn-sm delete-question-btn"
                      data-question-id="{{ question.id }}"
                    >
                      Excluir Pergunta
                    </button>
                  </div>
                </form>
              </div>
            </div>
            {% endfor %} {% else %}
            <div class="alert alert-info text-center">
              <h5>Nenhuma pergunta cadastrada ainda</h5>
              <p>Use o formulário acima para adicionar a primeira pergunta.</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Seção de Alterar Senha -->
      <div class="card">
        <div class="card-header">
          <h4 class="mb-0">Alterar Senha</h4>
        </div>
        <div class="card-body">
          <form
            id="change-password-form"
            method="POST"
            action="{{ url_for('main.change_password') }}"
          >
            <div class="row">
              <div class="col-md-6">
                <label class="form-label">Nova Senha</label>
                <input type="password" class="form-control" name="new_password" required />
              </div>
              <div class="col-md-6 d-flex align-items-end">
                <button type="submit" class="btn btn-warning">Alterar Senha</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='admin.js') }}"></script>
  </body>
</html>
